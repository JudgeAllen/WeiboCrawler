# 智能调度器配置说明

## 概述

智能调度器会根据实际更新情况自动调整轮询间隔，避免无意义的频繁检查，同时确保新微博能及时获取。

## 核心逻辑

```
正常状态（5分钟）→ 连续N次无更新 → 延长状态（15分钟）
                                      ↓
                    发现新微博 ← 保持延长状态
                      ↓
                  恢复正常状态（5分钟）
```

**重要特性**：
- ✅ **只延长一次**：延长到15分钟后，即使继续无更新也不会再延长
- ✅ **立即恢复**：一旦发现新微博，立即恢复到5分钟间隔
- ✅ **时段控制**：仅在指定时段内运行（如7:00-24:00）
- ✅ **状态持久**：重启后从正常间隔开始

## 配置参数详解

在 `crawler/config.json` 中添加 `scheduler` 配置块：

```json
{
  "scheduler": {
    "active_start_hour": 7,
    "active_end_hour": 24,
    "normal_interval_minutes": 5,
    "extended_interval_minutes": 15,
    "no_update_threshold": 3
  }
}
```

### 参数说明

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `active_start_hour` | int | 7 | 活跃时段开始时间（0-23，表示几点） |
| `active_end_hour` | int | 24 | 活跃时段结束时间（0-24，表示几点） |
| `normal_interval_minutes` | int | 5 | 正常轮询间隔（分钟） |
| `extended_interval_minutes` | int | 15 | 延长后的轮询间隔（分钟） |
| `no_update_threshold` | int | 3 | 连续几次无更新后触发延长 |

### 时段配置示例

**示例1：全天运行，晚上减少频率**
```json
{
  "active_start_hour": 0,
  "active_end_hour": 24,
  "normal_interval_minutes": 5,
  "extended_interval_minutes": 30,
  "no_update_threshold": 5
}
```

**示例2：仅工作时间运行**
```json
{
  "active_start_hour": 9,
  "active_end_hour": 18,
  "normal_interval_minutes": 3,
  "extended_interval_minutes": 10,
  "no_update_threshold": 2
}
```

**示例3：夜间运行（跨0点）**
```json
{
  "active_start_hour": 22,
  "active_end_hour": 6,
  "normal_interval_minutes": 10,
  "extended_interval_minutes": 30,
  "no_update_threshold": 3
}
```

## 运行示例

### 启动调度器

```bash
python scheduler.py
```

### 输出示例

```
============================================================
微博智能调度器
============================================================
活跃时间: 7:00 - 24:00
正常间隔: 5 分钟
延长间隔: 15 分钟
延长阈值: 连续 3 次无更新
启动时间: 2026-01-08 14:30:00
按 Ctrl+C 停止运行
============================================================

============================================================
定时任务触发: 2026-01-08 14:30:00
当前间隔: 5分钟 | 无更新次数: 0
============================================================
tombkeeper | 检查微博更新...
tombkeeper | 已有31765条微博
tombkeeper | 检查长文本...
tombkeeper | 本次抓取: 0条新微博

- 没有新微博
本轮爬取耗时: 2.3秒

下次运行时间: 2026-01-08 14:35:00
等待 5 分钟...

============================================================
定时任务触发: 2026-01-08 14:35:00
当前间隔: 5分钟 | 无更新次数: 1
============================================================
...

>>> 连续 3 次无更新，间隔延长为 15 分钟

下次运行时间: 2026-01-08 14:50:00
等待 15 分钟...

============================================================
定时任务触发: 2026-01-08 15:05:00
当前间隔: 15分钟 | 无更新次数: 4
============================================================
tombkeeper | 检查微博更新...

✓ 发现 2 条新微博

>>> 发现新内容，间隔恢复为 5 分钟

下次运行时间: 2026-01-08 15:10:00
等待 5 分钟...
```

## 工作流程详解

### 正常运行流程

1. **启动阶段**
   - 检查当前时间是否在活跃时段
   - 如果不在，等待到活跃时段开始
   - 初始间隔设为正常间隔（5分钟）

2. **检查阶段**
   - 记录数据库中当前微博数量
   - 运行爬虫抓取
   - 对比抓取后的数量，判断是否有新内容

3. **间隔调整**
   - **有新内容**：重置计数器，如果之前延长过则恢复到正常间隔
   - **无新内容**：计数器+1，达到阈值后延长间隔（仅延长一次）

4. **等待下次检查**
   - 显示下次运行时间
   - 按当前间隔等待

### 非活跃时段处理

当前时间不在 `[active_start_hour, active_end_hour)` 范围内时：
- 显示当前时间和下次活跃时间
- 每小时检查一次是否进入活跃时段
- 不运行爬虫，不消耗资源

例如：
```
当前时间 2:00 不在活跃时段
下次活跃时间: 2026-01-09 07:00:00
等待 5 小时...
```

## 与系统定时任务的对比

| 特性 | 智能调度器 | Windows任务计划程序 | Linux crontab |
|------|-----------|-------------------|--------------|
| 动态调整间隔 | ✅ | ❌ | ❌ |
| 时段控制 | ✅ | ✅ | ✅ |
| 实时日志 | ✅ | ⚠️ 需查看日志文件 | ⚠️ 需查看日志文件 |
| 启动开机自启 | ❌ | ✅ | ✅ |
| 资源占用 | 低（一直运行） | 极低（按需启动） | 极低（按需启动） |
| 配置难度 | 简单 | 中等 | 简单 |

**推荐使用场景**：
- **智能调度器**：开发调试、需要实时查看日志、需要动态调整间隔
- **系统定时任务**：生产环境、服务器部署、需要开机自启

## 故障排查

### 1. 调度器不在活跃时间运行

**问题**：设置了7:00-24:00，但调度器一直显示"不在活跃时段"

**原因**：`active_end_hour: 24` 表示到凌晨0点（不包含0点），实际范围是7:00-23:59

**解决**：
- 想要全天运行：`active_start_hour: 0, active_end_hour: 24`
- 想要到凌晨1点：`active_start_hour: 7, active_end_hour: 25` (会自动处理为1点)

### 2. 间隔没有延长

**问题**：连续多次无更新，但还是5分钟间隔

**检查**：
- 查看输出中的"无更新次数"是否递增
- 确认 `no_update_threshold` 配置正确
- 检查是否有微博ID更新但内容相同（仍算有更新）

### 3. 延长后无法恢复

**问题**：发现新微博后，间隔没有恢复到5分钟

**检查**：
- 查看输出是否显示"✓ 发现 X 条新微博"
- 检查数据库路径是否正确
- 确认新微博确实保存到了数据库

### 4. 调度器占用资源过高

**问题**：调度器一直占用CPU

**原因**：等待时使用了 `time.sleep()`，正常情况下应该几乎不占用CPU

**检查**：
- 是否有其他程序在同时访问数据库导致锁死
- 检查爬虫是否因为网络问题一直重试

## 高级使用

### 在后台运行（Linux/Mac）

```bash
nohup python scheduler.py > scheduler.log 2>&1 &
```

查看日志：
```bash
tail -f scheduler.log
```

### 在后台运行（Windows）

使用Windows服务包装器（如NSSM）：

1. 下载NSSM: https://nssm.cc/download
2. 安装服务：
```cmd
nssm install WeiboScheduler "C:\Python\python.exe" "f:\Git\tombkeeper\scheduler.py"
nssm set WeiboScheduler AppDirectory "f:\Git\tombkeeper"
nssm start WeiboScheduler
```

### 发送通知（可选）

修改 `scheduler.py` 的 `run_crawler()` 方法，在发现新微博时发送通知：

```python
if has_new_content:
    print(f"\n✓ 发现 {new_count} 条新微博")
    # 发送邮件/微信/Telegram通知
    send_notification(f"发现 {new_count} 条新微博")
```

## 参考资料

- [Windows计划任务指南](WINDOWS_TASK_SCHEDULER.md)
- [部署文档](DEPLOYMENT.md)
- [主文档](README.md)
