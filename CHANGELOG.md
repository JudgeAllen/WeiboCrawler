# 更新日志

## 2026-01-08 - 智能调度器

### ✨ 新功能

#### 智能调度器
**功能**: 根据实际更新情况自动调整轮询间隔
**特性**:
- 活跃时段控制：仅在7:00-24:00运行（可配置）
- 正常间隔：每5分钟检查一次
- 智能延长：连续3次无更新后延长到15分钟
- 自动恢复：发现新微博立即恢复到5分钟
- 只延长一次：延长后即使继续无更新也不再增加

**配置参数**（在 `crawler/config.json`）:
```json
{
  "scheduler": {
    "active_start_hour": 7,
    "active_end_hour": 24,
    "normal_interval_minutes": 5,
    "extended_interval_minutes": 15,
    "no_update_threshold": 3
  }
}
```

**使用方法**:
```bash
python scheduler.py
```

详细说明见 [SCHEDULER_CONFIG.md](SCHEDULER_CONFIG.md)

### 🐛 修复

#### 中文搜索问题
**问题**: 无法通过中文关键词搜索微博
**原因**: FTS5全文搜索使用porter分词器，不支持中文分词
**修复**: 检测中文字符，中文查询使用LIKE，英文查询使用FTS5
**结果**: 中文和英文搜索均正常工作

#### 长文本截断问题
**问题**: 超过140字的长微博内容被截断
**原因**: API返回的text_raw字段对长文本不完整
**修复**: 检测isLongText标志，调用`/ajax/statuses/longtext`获取完整内容
**结果**: 长文本完整保存（20.3%的微博为长文本）

### 🎨 界面改进

#### 图片灯箱
**功能**: 点击图片弹出放大查看，无需打开新页面
**特性**:
- 点击图片外区域关闭
- 按ESC键关闭
- 平滑缩放动画

#### 日期范围筛选
**功能**: 按日期范围查询微博
**特性**:
- HTML5日期选择器
- 快捷选择（今天、最近7天、最近30天、本年）
- 按时间倒序显示结果

---

## 2025-12-31 - 重大更新

### ✅ 已修复的问题

#### 1. 搜索功能无效
**问题**: 搜索索引文件未生成，搜索功能完全无法使用
**原因**: `copy_assets()` 在 `generate_search_index()` 之后执行，导致搜索索引被删除
**修复**: 调整执行顺序，先复制静态资源，再生成搜索索引
**结果**: 搜索索引正常生成（6.8MB，包含19,568条微博）

#### 2. 微博显示顺序混乱
**问题**: 微博显示顺序完全随机，不是按时间排序
**原因**: 使用字符串格式的时间字段排序（"Wed Sep 30 2020"），导致排序错误
**修复**: 改用微博ID排序（ID是递增的，能正确反映时间顺序）
**代码**: `ORDER BY w.id DESC` 替代 `ORDER BY w.created_at DESC`

#### 3. 缺少翻页功能
**问题**: 所有微博显示在一个页面，性能差且难以浏览
**修复**:
- 添加分页逻辑，每页显示50条微博
- 首页生成392页
- 用户页按用户分别生成多页
- 添加"上一页/下一页"导航
- 添加页面状态显示（第 X / Y 页）

### 🎯 改进的功能

#### 真正的增量更新
**之前**: 每次运行都会重新爬取所有页面，浪费大量时间
**现在**:
- 首次爬取：完整获取所有微博
- 增量更新：只爬取新发布的微博
- 智能停止：连续40条都是已存在的微博时自动停止
- tombkeeper (16,078条): 增量更新仅需5-10秒
- t0mbkeeper (3,490条): 首次爬取约2小时

#### 数据库优化
- 使用 `INSERT` 替代 `INSERT OR REPLACE`，避免重复插入
- 添加 `weibo_exists()` 检查，提升性能

### 📊 当前数据统计

- **用户数**: 2个
  - tombkeeper: 16,078 条微博（322页）
  - t0mbkeeper: 3,490 条微博（70页）
- **总微博数**: 19,568 条
- **总页数**: 392 页
- **搜索索引**: 19,568 条记录（6.8MB）

### 🎨 界面改进

#### 分页导航样式
- 橙色按钮设计，与tombkeeper.io风格一致
- 悬停效果（透明度变化 + 向上移动）
- 响应式设计，适配移动端

#### 页面结构
```
首页:
  /index.html         (第1页)
  /page-2.html        (第2页)
  /page-3.html        (第3页)
  ...

用户页:
  /users/1401527553.html          (tombkeeper 第1页)
  /users/1401527553-page-2.html   (tombkeeper 第2页)
  /users/6827625527.html          (t0mbkeeper 第1页)
  ...

详情页:
  /posts/[微博ID].html
```

## 使用说明

### 智能调度器（推荐）
```bash
python scheduler.py
```

### 重新生成网站
```bash
cd generator
python build.py
```

### 增量更新微博
```bash
cd crawler
python weibo_spider.py
```

### 启动动态服务器
```bash
python app.py
# 访问 http://localhost:5000
```

## 技术细节

### 排序说明
微博ID格式：4554953748648860（19位数字）
- 越大的ID表示越新的微博
- 使用 `ORDER BY id DESC` 可以正确按时间倒序排列

### 分页逻辑
```python
per_page = 50
total_pages = (total_count + per_page - 1) // per_page
offset = (page - 1) * per_page
```

### 搜索索引结构
```json
[
  {
    "id": "微博ID",
    "content": "微博内容",
    "created_at": "发布时间",
    "user_name": "用户名"
  }
]
```
